## run_perform_iterative_qPAI_reconstruction

active_bytes reserved_bytes line code                                                                                                                                   
         all            all                                                                                                                                             
        peak           peak                                                                                                                                             
       8.12M         24.00M   25 @profile                                                                                                                               
                              26 def run_perform_iterative_qPAI_reconstruction(SPACING: Union[int, float] = 0.2, path_manager=sp.PathManager(), visualise:bool = True): 
                              27     """                                                                                                                                
                              28                                                                                                                                        
                              29     :param SPACING: The simulation spacing between voxels                                                                              
                              30     :param path_manager: the path manager to be used, typically sp.PathManager                                                         
                              31     :param visualise: If VISUALIZE is set to True, the reconstruction result will be plotted                                           
                              32     :return: a run through of the example                                                                                              
                              33     """                                                                                                                                
       8.12M         24.00M   34     VOLUME_TRANSDUCER_DIM_IN_MM = 30                                                                                                   
       8.12M         24.00M   35     VOLUME_PLANAR_DIM_IN_MM = 30                                                                                                       
       8.12M         24.00M   36     VOLUME_HEIGHT_IN_MM = 30                                                                                                           
       8.12M         24.00M   37     RANDOM_SEED = 471                                                                                                                  
       8.12M         24.00M   38     VOLUME_NAME = "MyqPAIReconstruction_" + str(RANDOM_SEED)                                                                           
                              39                                                                                                                                        
                              40     # If VISUALIZE is set to True, the reconstruction result will be plotted                                                           
                              41                                                                                                                                        
       8.12M         24.00M   42     def create_example_tissue():                                                                                                       
                              43         """                                                                                                                            
                              44         This is a very simple example script of how to create a tissue definition.                                                     
                              45         It contains a muscular background, an epidermis layer on top of the muscles                                                    
                              46         and a blood vessel.                                                                                                            
                              47         """                                                                                                                            
                              48         background_dictionary = sp.Settings()                                                                                          
                              49         background_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(0.05, 30, 0.9)                                   
                              50         background_dictionary[Tags.STRUCTURE_TYPE] = Tags.BACKGROUND                                                                   
                              51                                                                                                                                        
                              52         epidermis_structure = sp.Settings()                                                                                            
                              53         epidermis_structure[Tags.PRIORITY] = 1                                                                                         
                              54         epidermis_structure[Tags.STRUCTURE_START_MM] = [0, 0, 2]                                                                       
                              55         epidermis_structure[Tags.STRUCTURE_END_MM] = [0, 0, 2.5]                                                                       
                              56         epidermis_structure[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(2.2, 100.0, 0.9)                                   
                              57         epidermis_structure[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                                       
                              58         epidermis_structure[Tags.ADHERE_TO_DEFORMATION] = True                                                                         
                              59         epidermis_structure[Tags.STRUCTURE_TYPE] = Tags.HORIZONTAL_LAYER_STRUCTURE                                                     
                              60                                                                                                                                        
                              61         vessel_structure_1 = sp.Settings()                                                                                             
                              62         vessel_structure_1[Tags.PRIORITY] = 2                                                                                          
                              63         vessel_structure_1[Tags.STRUCTURE_START_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM / 2.5, 0,                                           
                              64                                                        VOLUME_HEIGHT_IN_MM / 2]                                                        
                              65         vessel_structure_1[Tags.STRUCTURE_END_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM / 2.5,                                                
                              66                                                      VOLUME_PLANAR_DIM_IN_MM, VOLUME_HEIGHT_IN_MM / 2]                                 
                              67         vessel_structure_1[Tags.STRUCTURE_RADIUS_MM] = 1.75                                                                            
                              68         vessel_structure_1[Tags.STRUCTURE_ECCENTRICITY] = 0.85                                                                         
                              69         vessel_structure_1[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(5.2, 100.0, 0.9)                                    
                              70         vessel_structure_1[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                                        
                              71         vessel_structure_1[Tags.ADHERE_TO_DEFORMATION] = True                                                                          
                              72         vessel_structure_1[Tags.STRUCTURE_TYPE] = Tags.ELLIPTICAL_TUBULAR_STRUCTURE                                                    
                              73                                                                                                                                        
                              74         vessel_structure_2 = sp.Settings()                                                                                             
                              75         vessel_structure_2[Tags.PRIORITY] = 3                                                                                          
                              76         vessel_structure_2[Tags.STRUCTURE_START_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM / 2, 0,                                             
                              77                                                        VOLUME_HEIGHT_IN_MM / 3]                                                        
                              78         vessel_structure_2[Tags.STRUCTURE_END_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM / 2,                                                  
                              79                                                      VOLUME_PLANAR_DIM_IN_MM, VOLUME_HEIGHT_IN_MM / 3]                                 
                              80         vessel_structure_2[Tags.STRUCTURE_RADIUS_MM] = 0.75                                                                            
                              81         vessel_structure_2[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(3.0, 100.0, 0.9)                                    
                              82         vessel_structure_2[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                                        
                              83         vessel_structure_2[Tags.STRUCTURE_TYPE] = Tags.CIRCULAR_TUBULAR_STRUCTURE                                                      
                              84                                                                                                                                        
                              85         tissue_dict = sp.Settings()                                                                                                    
                              86         tissue_dict[Tags.BACKGROUND] = background_dictionary                                                                           
                              87         tissue_dict["epidermis"] = epidermis_structure                                                                                 
                              88         tissue_dict["vessel_1"] = vessel_structure_1                                                                                   
                              89         tissue_dict["vessel_2"] = vessel_structure_2                                                                                   
                              90         return tissue_dict                                                                                                             
                              91                                                                                                                                        
                              92                                                                                                                                        
                              93     # set settings for volume creation, optical simulation and iterative qPAI method                                                   
       8.12M         24.00M   94     np.random.seed(RANDOM_SEED)                                                                                                        
                              95                                                                                                                                        
       8.12M         24.00M   96     general_settings = {                                                                                                               
                              97         # These parameters set the general properties of the simulated volume                                                          
       8.12M         24.00M   98         Tags.RANDOM_SEED: RANDOM_SEED,                                                                                                 
       8.12M         24.00M   99         Tags.VOLUME_NAME: VOLUME_NAME,                                                                                                 
       8.12M         24.00M  100         Tags.SIMULATION_PATH: path_manager.get_hdf5_file_save_path(),                                                                  
       8.12M         24.00M  101         Tags.SPACING_MM: SPACING,                                                                                                      
       8.12M         24.00M  102         Tags.DIM_VOLUME_Z_MM: VOLUME_HEIGHT_IN_MM,                                                                                     
       8.12M         24.00M  103         Tags.DIM_VOLUME_X_MM: VOLUME_TRANSDUCER_DIM_IN_MM,                                                                             
       8.12M         24.00M  104         Tags.DIM_VOLUME_Y_MM: VOLUME_PLANAR_DIM_IN_MM,                                                                                 
       8.12M         24.00M  105         Tags.WAVELENGTHS: [700]                                                                                                        
                             106     }                                                                                                                                  
                             107                                                                                                                                        
       8.12M         24.00M  108     settings = sp.Settings(general_settings)                                                                                           
                             109                                                                                                                                        
       8.12M         24.00M  110     settings.set_volume_creation_settings({                                                                                            
                             111         # These parameters set the properties for the volume creation                                                                  
       8.12M         24.00M  112         Tags.SIMULATE_DEFORMED_LAYERS: True,                                                                                           
       8.12M         24.00M  113         Tags.STRUCTURES: create_example_tissue()                                                                                       
                             114     })                                                                                                                                 
       8.12M         24.00M  115     settings.set_optical_settings({                                                                                                    
                             116         # These parameters set the properties for the optical Monte Carlo simulation                                                   
       8.12M         24.00M  117         Tags.OPTICAL_MODEL_NUMBER_PHOTONS: 1e7,                                                                                        
       8.12M         24.00M  118         Tags.OPTICAL_MODEL_BINARY_PATH: path_manager.get_mcx_binary_path(),                                                            
       8.12M         24.00M  119         Tags.OPTICAL_MODEL: Tags.OPTICAL_MODEL_MCX,                                                                                    
       8.12M         24.00M  120         Tags.LASER_PULSE_ENERGY_IN_MILLIJOULE: 50                                                                                      
                             121     })                                                                                                                                 
       8.12M         24.00M  122     settings["noise_model"] = {                                                                                                        
       8.12M         24.00M  123         Tags.NOISE_MEAN: 1.0,                                                                                                          
       8.12M         24.00M  124         Tags.NOISE_STD: 0.01,                                                                                                          
       8.12M         24.00M  125         Tags.NOISE_MODE: Tags.NOISE_MODE_MULTIPLICATIVE,                                                                               
       8.12M         24.00M  126         Tags.DATA_FIELD: Tags.DATA_FIELD_INITIAL_PRESSURE,                                                                             
       8.12M         24.00M  127         Tags.NOISE_NON_NEGATIVITY_CONSTRAINT: True                                                                                     
                             128     }                                                                                                                                  
       8.12M         24.00M  129     settings["iterative_qpai_reconstruction"] = {                                                                                      
                             130         # These parameters set the properties of the iterative reconstruction                                                          
       8.12M         24.00M  131         Tags.DOWNSCALE_FACTOR: 0.75,                                                                                                   
       8.12M         24.00M  132         Tags.ITERATIVE_RECONSTRUCTION_CONSTANT_REGULARIZATION: False,                                                                  
                             133         # the following tag has no effect, since the regularization is chosen to be SNR dependent, not constant                        
       8.12M         24.00M  134         Tags.ITERATIVE_RECONSTRUCTION_REGULARIZATION_SIGMA: 0.01,                                                                      
       8.12M         24.00M  135         Tags.ITERATIVE_RECONSTRUCTION_MAX_ITERATION_NUMBER: 20,                                                                        
                             136         # for this example, we are not interested in all absorption updates                                                            
       8.12M         24.00M  137         Tags.ITERATIVE_RECONSTRUCTION_SAVE_INTERMEDIATE_RESULTS: False,                                                                
       8.12M         24.00M  138         Tags.ITERATIVE_RECONSTRUCTION_STOPPING_LEVEL: 1e-3                                                                             
                             139     }                                                                                                                                  
                             140                                                                                                                                        
                             141     # run pipeline including iterative qPAI method                                                                                     
       8.12M         24.00M  142     pipeline = [                                                                                                                       
       8.12M         24.00M  143         sp.ModelBasedVolumeCreationAdapter(settings),                                                                                  
       8.12M         24.00M  144         sp.MCXAdapter(settings),                                                                                                       
       8.12M         24.00M  145         sp.GaussianNoise(settings, "noise_model"),                                                                                     
       8.12M         24.00M  146         sp.IterativeqPAI(settings, "iterative_qpai_reconstruction")                                                                    
                             147     ]                                                                                                                                  
                             148                                                                                                                                        
                             149                                                                                                                                        
       8.12M         24.00M  150     class CustomDevice(sp.PhotoacousticDevice):                                                                                        
                             151                                                                                                                                        
                             152         def __init__(self):                                                                                                            
                             153             super(CustomDevice, self).__init__(device_position_mm=np.asarray([general_settings[Tags.DIM_VOLUME_X_MM] / 2,              
                             154                                                                               general_settings[Tags.DIM_VOLUME_Y_MM] / 2,              
                             155                                                                               0]))                                                     
                             156             self.add_illumination_geometry(sp.DiskIlluminationGeometry(beam_radius_mm=20))                                             
                             157                                                                                                                                        
                             158                                                                                                                                        
       8.12M         24.00M  159     device = CustomDevice()                                                                                                            
                             160                                                                                                                                        
       8.12M         24.00M  161     device.update_settings_for_use_of_model_based_volume_creator(settings)                                                             
                             162                                                                                                                                        
      52.01M         66.00M  163     sp.simulate(pipeline, settings, device)                                                                                            
                             164                                                                                                                                        
                             165     # visualize reconstruction results                                                                                                 
       8.12M         22.00M  166     if visualise:                                                                                                                      
                             167         # get simulation output                                                                                                        
                             168         data_path = path_manager.get_hdf5_file_save_path() + "/" + VOLUME_NAME + ".hdf5"                                               
                             169         settings = sp.load_data_field(data_path, Tags.SETTINGS)                                                                        
                             170         wavelength = settings[Tags.WAVELENGTHS][0]                                                                                     
                             171                                                                                                                                        
                             172         # get reconstruction result                                                                                                    
                             173         absorption_reconstruction = sp.load_data_field(data_path, Tags.ITERATIVE_qPAI_RESULT, wavelength)                              
                             174                                                                                                                                        
                             175         # get ground truth absorption coefficients                                                                                     
                             176         absorption_gt = sp.load_data_field(data_path, Tags.DATA_FIELD_ABSORPTION_PER_CM, wavelength)                                   
                             177                                                                                                                                        
                             178         # rescale ground truth to same dimension as reconstruction (necessary due to resampling in iterative algorithm)                
                             179         scale = np.shape(absorption_reconstruction)[0] / np.shape(absorption_gt)[0]  # same as Tags.DOWNSCALE_FACTOR                   
                             180         absorption_gt = zoom(absorption_gt, scale, order=1, mode="nearest")                                                            
                             181                                                                                                                                        
                             182         # compute reconstruction error                                                                                                 
                             183         difference = absorption_gt - absorption_reconstruction                                                                         
                             184                                                                                                                                        
                             185         median_error = np.median(difference)                                                                                           
                             186         q3, q1 = np.percentile(difference, [75, 25])                                                                                   
                             187         iqr = q3 - q1                                                                                                                  
                             188                                                                                                                                        
                             189         # visualize results                                                                                                            
                             190         x_pos = int(np.shape(absorption_gt)[0] / 2)                                                                                    
                             191         y_pos = int(np.shape(absorption_gt)[1] / 2)                                                                                    
                             192                                                                                                                                        
                             193         if np.min(absorption_gt) > np.min(absorption_reconstruction):                                                                  
                             194             cmin = np.min(absorption_reconstruction)                                                                                   
                             195         else:                                                                                                                          
                             196             cmin = np.min(absorption_gt)                                                                                               
                             197                                                                                                                                        
                             198         if np.max(absorption_gt) > np.max(absorption_reconstruction):                                                                  
                             199             cmax = np.max(absorption_gt)                                                                                               
                             200         else:                                                                                                                          
                             201             cmax = np.max(absorption_reconstruction)                                                                                   
                             202                                                                                                                                        
                             203         results_x_z = [absorption_gt[:, y_pos, :], absorption_reconstruction[:, y_pos, :], difference[:, y_pos, :]]                    
                             204         results_y_z = [absorption_gt[x_pos, :, :], absorption_reconstruction[x_pos, :, :], difference[x_pos, :, :]]                    
                             205                                                                                                                                        
                             206         label = ["Absorption coefficients: ${\mu_a}^{gt}$", "Reconstruction: ${\mu_a}^{reconstr.}$",                                   
                             207                  "Difference: ${\mu_a}^{gt} - {\mu_a}^{reconstr.}$"]                                                                   
                             208                                                                                                                                        
                             209         plt.figure(figsize=(20, 15))                                                                                                   
                             210         plt.subplots_adjust(hspace=0.5)                                                                                                
                             211         plt.suptitle("Iterative qPAI Reconstruction \n median error = " + str(np.round(median_error, 4)) +                             
                             212                      "\n IQR = " + str(np.round(iqr, 4)), fontsize=10)                                                                 
                             213                                                                                                                                        
                             214         for i, quantity in enumerate(results_x_z):                                                                                     
                             215             plt.subplot(2, len(results_x_z), i + 1)                                                                                    
                             216             if i == 0:                                                                                                                 
                             217                 plt.ylabel("x-z", fontsize=10)                                                                                         
                             218             plt.title(label[i], fontsize=10)                                                                                           
                             219             plt.imshow(quantity.T)                                                                                                     
                             220             plt.xticks(fontsize=6)                                                                                                     
                             221             plt.yticks(fontsize=6)                                                                                                     
                             222             plt.colorbar()                                                                                                             
                             223             if i != 2:                                                                                                                 
                             224                 plt.clim(cmin, cmax)                                                                                                   
                             225             else:                                                                                                                      
                             226                 plt.clim(np.min(difference), np.max(difference))                                                                       
                             227                                                                                                                                        
                             228         for i, quantity in enumerate(results_y_z):                                                                                     
                             229             plt.subplot(2, len(results_x_z), i + len(results_x_z) + 1)                                                                 
                             230             if i == 0:                                                                                                                 
                             231                 plt.ylabel("y-z", fontsize=10)                                                                                         
                             232             plt.title(label[i], fontsize=10)                                                                                           
                             233             plt.imshow(quantity.T)                                                                                                     
                             234             plt.xticks(fontsize=6)                                                                                                     
                             235             plt.yticks(fontsize=6)                                                                                                     
                             236             plt.colorbar()                                                                                                             
                             237             if i != 2:                                                                                                                 
                             238                 plt.clim(cmin, cmax)                                                                                                   
                             239             else:                                                                                                                      
                             240                 plt.clim(np.min(difference), np.max(difference))                                                                       
                             241                                                                                                                                        
                             242         plt.show()                                                                                                                     
                             243         plt.close()                                                                                                                    
## run_optical_and_acoustic_simulation

active_bytes reserved_bytes line code                                                                                                                                  
         all            all                                                                                                                                            
        peak           peak                                                                                                                                            
       8.12M         20.00M   18 @profile                                                                                                                              
                              19 def run_optical_and_acoustic_simulation(SPACING: Union[int, float] = 0.2, path_manager=sp.PathManager(),                              
                              20                                      visualise: bool = True):                                                                         
                              21     """                                                                                                                               
                              22                                                                                                                                       
                              23     :param SPACING: The simulation spacing between voxels                                                                             
                              24     :param path_manager: the path manager to be used, typically sp.PathManager                                                        
                              25     :param visualise: If VISUALIZE is set to True, the reconstruction result will be plotted                                          
                              26     :return: a run through of the example                                                                                             
                              27     """                                                                                                                               
       8.12M         20.00M   28     VOLUME_TRANSDUCER_DIM_IN_MM = 75                                                                                                  
       8.12M         20.00M   29     VOLUME_PLANAR_DIM_IN_MM = 20                                                                                                      
       8.12M         20.00M   30     VOLUME_HEIGHT_IN_MM = 25                                                                                                          
       8.12M         20.00M   31     RANDOM_SEED = 4711                                                                                                                
                              32                                                                                                                                       
                              33     # If VISUALIZE is set to True, the simulation result will be plotted                                                              
       8.12M         20.00M   34     VISUALIZE = True                                                                                                                  
                              35                                                                                                                                       
       8.12M         20.00M   36     def create_example_tissue():                                                                                                      
                              37         """                                                                                                                           
                              38         This is a very simple example script of how to create a tissue definition.                                                    
                              39         It contains a muscular background, an epidermis layer on top of the muscles                                                   
                              40         and a blood vessel.                                                                                                           
                              41         """                                                                                                                           
                              42         background_dictionary = sp.Settings()                                                                                         
                              43         background_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(1e-10, 1e-10, 1.0)                              
                              44         background_dictionary[Tags.STRUCTURE_TYPE] = Tags.BACKGROUND                                                                  
                              45                                                                                                                                       
                              46         tissue_dict = sp.Settings()                                                                                                   
                              47         tissue_dict[Tags.BACKGROUND] = background_dictionary                                                                          
                              48         tissue_dict["muscle"] = sp.define_horizontal_layer_structure_settings(z_start_mm=0, thickness_mm=100,                         
                              49                                                                               molecular_composition=sp.TISSUE_LIBRARY.constant(       
                              50                                                                                   0.05, 100, 0.9),                                    
                              51                                                                               priority=1,                                             
                              52                                                                               consider_partial_volume=True,                           
                              53                                                                               adhere_to_deformation=True)                             
                              54         tissue_dict["epidermis"] = sp.define_horizontal_layer_structure_settings(z_start_mm=1, thickness_mm=0.1,                      
                              55                                                                                  molecular_composition=sp.TISSUE_LIBRARY.epidermis(), 
                              56                                                                                  priority=8,                                          
                              57                                                                                  consider_partial_volume=True,                        
                              58                                                                                  adhere_to_deformation=True)                          
                              59         tissue_dict["vessel_1"] = sp.define_circular_tubular_structure_settings(                                                      
                              60             tube_start_mm=[VOLUME_TRANSDUCER_DIM_IN_MM/2 - 10, 0, 5],                                                                 
                              61             tube_end_mm=[VOLUME_TRANSDUCER_DIM_IN_MM/2 - 10, VOLUME_PLANAR_DIM_IN_MM, 5],                                             
                              62             molecular_composition=sp.TISSUE_LIBRARY.blood(),                                                                          
                              63             radius_mm=2, priority=3, consider_partial_volume=True,                                                                    
                              64             adhere_to_deformation=False                                                                                               
                              65         )                                                                                                                             
                              66         tissue_dict["vessel_2"] = sp.define_circular_tubular_structure_settings(                                                      
                              67             tube_start_mm=[VOLUME_TRANSDUCER_DIM_IN_MM/2, 0, 10],                                                                     
                              68             tube_end_mm=[VOLUME_TRANSDUCER_DIM_IN_MM/2, VOLUME_PLANAR_DIM_IN_MM, 10],                                                 
                              69             molecular_composition=sp.TISSUE_LIBRARY.blood(),                                                                          
                              70             radius_mm=3, priority=3, consider_partial_volume=True,                                                                    
                              71             adhere_to_deformation=False                                                                                               
                              72         )                                                                                                                             
                              73         return tissue_dict                                                                                                            
                              74                                                                                                                                       
                              75                                                                                                                                       
                              76     # Seed the numpy random configuration prior to creating the global_settings file in                                               
                              77     # order to ensure that the same volume                                                                                            
                              78     # is generated with the same random seed every time.                                                                              
                              79                                                                                                                                       
       8.12M         20.00M   80     np.random.seed(RANDOM_SEED)                                                                                                       
       8.12M         20.00M   81     VOLUME_NAME = "CompletePipelineTestMSOT_"+str(RANDOM_SEED)                                                                        
                              82                                                                                                                                       
       8.12M         20.00M   83     general_settings = {                                                                                                              
                              84         # These parameters set the general properties of the simulated volume                                                         
       8.12M         20.00M   85         Tags.RANDOM_SEED: RANDOM_SEED,                                                                                                
       8.12M         20.00M   86         Tags.VOLUME_NAME: "CompletePipelineExample_" + str(RANDOM_SEED),                                                              
       8.12M         20.00M   87         Tags.SIMULATION_PATH: path_manager.get_hdf5_file_save_path(),                                                                 
       8.12M         20.00M   88         Tags.SPACING_MM: SPACING,                                                                                                     
       8.12M         20.00M   89         Tags.DIM_VOLUME_Z_MM: VOLUME_HEIGHT_IN_MM,                                                                                    
       8.12M         20.00M   90         Tags.DIM_VOLUME_X_MM: VOLUME_TRANSDUCER_DIM_IN_MM,                                                                            
       8.12M         20.00M   91         Tags.DIM_VOLUME_Y_MM: VOLUME_PLANAR_DIM_IN_MM,                                                                                
       8.12M         20.00M   92         Tags.VOLUME_CREATOR: Tags.VOLUME_CREATOR_VERSATILE,                                                                           
       8.12M         20.00M   93         Tags.GPU: True,                                                                                                               
       8.12M         20.00M   94         Tags.WAVELENGTHS: [700, 800],                                                                                                 
       8.12M         20.00M   95         Tags.DO_FILE_COMPRESSION: True,                                                                                               
       8.12M         20.00M   96         Tags.DO_IPASC_EXPORT: True                                                                                                    
                              97     }                                                                                                                                 
       8.12M         20.00M   98     settings = sp.Settings(general_settings)                                                                                          
       8.12M         20.00M   99     np.random.seed(RANDOM_SEED)                                                                                                       
                             100                                                                                                                                       
       8.12M         20.00M  101     settings.set_volume_creation_settings({                                                                                           
       8.12M         20.00M  102         Tags.STRUCTURES: create_example_tissue(),                                                                                     
       8.12M         20.00M  103         Tags.SIMULATE_DEFORMED_LAYERS: True                                                                                           
                             104     })                                                                                                                                
                             105                                                                                                                                       
       8.12M         20.00M  106     settings.set_optical_settings({                                                                                                   
       8.12M         20.00M  107         Tags.OPTICAL_MODEL_NUMBER_PHOTONS: 1e7,                                                                                       
       8.12M         20.00M  108         Tags.OPTICAL_MODEL_BINARY_PATH: path_manager.get_mcx_binary_path(),                                                           
       8.12M         20.00M  109         Tags.ILLUMINATION_TYPE: Tags.ILLUMINATION_TYPE_MSOT_ACUITY_ECHO,                                                              
       8.12M         20.00M  110         Tags.LASER_PULSE_ENERGY_IN_MILLIJOULE: 50,                                                                                    
       8.12M         20.00M  111         Tags.MCX_ASSUMED_ANISOTROPY: 0.9,                                                                                             
                             112     })                                                                                                                                
                             113                                                                                                                                       
       8.12M         20.00M  114     settings.set_acoustic_settings({                                                                                                  
       8.12M         20.00M  115         Tags.ACOUSTIC_SIMULATION_3D: False,                                                                                           
       8.12M         20.00M  116         Tags.ACOUSTIC_MODEL_BINARY_PATH: path_manager.get_matlab_binary_path(),                                                       
       8.12M         20.00M  117         Tags.KWAVE_PROPERTY_ALPHA_POWER: 0.00,                                                                                        
       8.12M         20.00M  118         Tags.KWAVE_PROPERTY_SENSOR_RECORD: "p",                                                                                       
       8.12M         20.00M  119         Tags.KWAVE_PROPERTY_PMLInside: False,                                                                                         
       8.12M         20.00M  120         Tags.KWAVE_PROPERTY_PMLSize: [31, 32],                                                                                        
       8.12M         20.00M  121         Tags.KWAVE_PROPERTY_PMLAlpha: 1.5,                                                                                            
       8.12M         20.00M  122         Tags.KWAVE_PROPERTY_PlotPML: False,                                                                                           
       8.12M         20.00M  123         Tags.RECORDMOVIE: False,                                                                                                      
       8.12M         20.00M  124         Tags.MOVIENAME: "visualization_log",                                                                                          
       8.12M         20.00M  125         Tags.ACOUSTIC_LOG_SCALE: True                                                                                                 
                             126     })                                                                                                                                
                             127                                                                                                                                       
       8.12M         20.00M  128     settings.set_reconstruction_settings({                                                                                            
       8.12M         20.00M  129         Tags.RECONSTRUCTION_PERFORM_BANDPASS_FILTERING: False,                                                                        
       8.12M         20.00M  130         Tags.ACOUSTIC_MODEL_BINARY_PATH: path_manager.get_matlab_binary_path(),                                                       
       8.12M         20.00M  131         Tags.ACOUSTIC_SIMULATION_3D: False,                                                                                           
       8.12M         20.00M  132         Tags.KWAVE_PROPERTY_ALPHA_POWER: 0.00,                                                                                        
       8.12M         20.00M  133         Tags.TUKEY_WINDOW_ALPHA: 0.5,                                                                                                 
       8.12M         20.00M  134         Tags.BANDPASS_CUTOFF_LOWPASS_IN_HZ: int(8e6),                                                                                 
       8.12M         20.00M  135         Tags.BANDPASS_CUTOFF_HIGHPASS_IN_HZ: int(0.1e4),                                                                              
       8.12M         20.00M  136         Tags.RECONSTRUCTION_BMODE_AFTER_RECONSTRUCTION: False,                                                                        
       8.12M         20.00M  137         Tags.RECONSTRUCTION_BMODE_METHOD: Tags.RECONSTRUCTION_BMODE_METHOD_HILBERT_TRANSFORM,                                         
       8.12M         20.00M  138         Tags.RECONSTRUCTION_APODIZATION_METHOD: Tags.RECONSTRUCTION_APODIZATION_BOX,                                                  
       8.12M         20.00M  139         Tags.RECONSTRUCTION_MODE: Tags.RECONSTRUCTION_MODE_PRESSURE,                                                                  
       8.12M         20.00M  140         Tags.KWAVE_PROPERTY_SENSOR_RECORD: "p",                                                                                       
       8.12M         20.00M  141         Tags.KWAVE_PROPERTY_PMLInside: False,                                                                                         
       8.12M         20.00M  142         Tags.KWAVE_PROPERTY_PMLSize: [31, 32],                                                                                        
       8.12M         20.00M  143         Tags.KWAVE_PROPERTY_PMLAlpha: 1.5,                                                                                            
       8.12M         20.00M  144         Tags.KWAVE_PROPERTY_PlotPML: False,                                                                                           
       8.12M         20.00M  145         Tags.RECORDMOVIE: False,                                                                                                      
       8.12M         20.00M  146         Tags.MOVIENAME: "visualization_log",                                                                                          
       8.12M         20.00M  147         Tags.ACOUSTIC_LOG_SCALE: True,                                                                                                
       8.12M         20.00M  148         Tags.DATA_FIELD_SPEED_OF_SOUND: 1540,                                                                                         
       8.12M         20.00M  149         Tags.DATA_FIELD_ALPHA_COEFF: 0.01,                                                                                            
       8.12M         20.00M  150         Tags.DATA_FIELD_DENSITY: 1000,                                                                                                
       8.12M         20.00M  151         Tags.SPACING_MM: SPACING                                                                                                      
                             152     })                                                                                                                                
                             153                                                                                                                                       
       8.12M         20.00M  154     settings["noise_initial_pressure"] = {                                                                                            
       8.12M         20.00M  155         Tags.NOISE_MEAN: 1,                                                                                                           
       8.12M         20.00M  156         Tags.NOISE_STD: 0.01,                                                                                                         
       8.12M         20.00M  157         Tags.NOISE_MODE: Tags.NOISE_MODE_MULTIPLICATIVE,                                                                              
       8.12M         20.00M  158         Tags.DATA_FIELD: Tags.DATA_FIELD_INITIAL_PRESSURE,                                                                            
       8.12M         20.00M  159         Tags.NOISE_NON_NEGATIVITY_CONSTRAINT: True                                                                                    
                             160     }                                                                                                                                 
                             161                                                                                                                                       
       8.12M         20.00M  162     settings["noise_time_series"] = {                                                                                                 
       8.12M         20.00M  163         Tags.NOISE_STD: 1,                                                                                                            
       8.12M         20.00M  164         Tags.NOISE_MODE: Tags.NOISE_MODE_ADDITIVE,                                                                                    
       8.12M         20.00M  165         Tags.DATA_FIELD: Tags.DATA_FIELD_TIME_SERIES_DATA                                                                             
                             166     }                                                                                                                                 
                             167                                                                                                                                       
                             168     # TODO: For the device choice, uncomment the undesired device                                                                     
                             169                                                                                                                                       
                             170     # device = sp.MSOTAcuityEcho(device_position_mm=np.array([VOLUME_TRANSDUCER_DIM_IN_MM/2,                                          
                             171     #                                                      VOLUME_PLANAR_DIM_IN_MM/2,                                                 
                             172     #                                                      0]))                                                                       
                             173     # device.update_settings_for_use_of_model_based_volume_creator(settings)                                                          
                             174                                                                                                                                       
       8.12M         20.00M  175     device = sp.PhotoacousticDevice(device_position_mm=np.array([VOLUME_TRANSDUCER_DIM_IN_MM/2,                                       
       8.12M         20.00M  176                                                                  VOLUME_PLANAR_DIM_IN_MM/2,                                           
       8.12M         20.00M  177                                                                  0]),                                                                 
       8.12M         20.00M  178                                     field_of_view_extent_mm=np.asarray([-15, 15, 0, 0, 0, 20]))                                       
       8.12M         20.00M  179     device.set_detection_geometry(sp.LinearArrayDetectionGeometry(device_position_mm=device.device_position_mm,                       
       8.12M         20.00M  180                                                                   pitch_mm=0.25,                                                      
       8.12M         20.00M  181                                                                   number_detector_elements=100,                                       
       8.12M         20.00M  182                                                                   field_of_view_extent_mm=np.asarray([-15, 15, 0, 0, 0, 20])))        
       8.12M         20.00M  183     print(device.get_detection_geometry().get_detector_element_positions_base_mm())                                                   
       8.12M         20.00M  184     device.add_illumination_geometry(sp.SlitIlluminationGeometry(slit_vector_mm=[100, 0, 0]))                                         
                             185                                                                                                                                       
                             186                                                                                                                                       
       8.12M         20.00M  187     SIMULATION_PIPELINE = [                                                                                                           
       8.12M         20.00M  188         sp.ModelBasedVolumeCreationAdapter(settings),                                                                                 
       8.12M         20.00M  189         sp.MCXAdapter(settings),                                                                                                      
       8.12M         20.00M  190         sp.GaussianNoise(settings, "noise_initial_pressure"),                                                                         
       8.12M         20.00M  191         sp.KWaveAdapter(settings),                                                                                                    
       8.12M         20.00M  192         sp.GaussianNoise(settings, "noise_time_series"),                                                                              
       8.12M         20.00M  193         sp.TimeReversalAdapter(settings),                                                                                             
       8.12M         20.00M  194         sp.FieldOfViewCropping(settings)                                                                                              
                             195     ]                                                                                                                                 
                             196                                                                                                                                       
      62.10M         80.00M  197     sp.simulate(SIMULATION_PIPELINE, settings, device)                                                                                
                             198                                                                                                                                       
                             199     if Tags.WAVELENGTH in settings:                                                                                                   
                             200         WAVELENGTH = settings[Tags.WAVELENGTH]                                                                                        
                             201     else:                                                                                                                             
                             202         WAVELENGTH = 700                                                                                                              
                             203                                                                                                                                       
                             204     if visualise:                                                                                                                     
                             205         sp.visualise_data(path_to_hdf5_file=settings[Tags.SIMPA_OUTPUT_PATH],                                                         
                             206                           wavelength=WAVELENGTH,                                                                                      
                             207                           show_time_series_data=True,                                                                                 
                             208                           show_initial_pressure=True,                                                                                 
                             209                           show_reconstructed_data=True,                                                                               
                             210                           log_scale=False,                                                                                            
                             211                           show_xz_only=False)                                                                                         
## run_msot_invision_simulation

active_bytes reserved_bytes line code                                                                                                                         
         all            all                                                                                                                                   
        peak           peak                                                                                                                                   
       8.12M         20.00M   13 @profile                                                                                                                     
                              14 def run_msot_invision_simulation(SPACING: Union[int, float] = 0.5, path_manager=sp.PathManager(), visualise:bool = True):    
                              15     """                                                                                                                      
                              16                                                                                                                              
                              17     :param SPACING: The simulation spacing between voxels                                                                    
                              18     :param path_manager: the path manager to be used, typically sp.PathManager                                               
                              19     :param visualise: If VISUALIZE is set to True, the reconstruction result will be plotted                                 
                              20     :return: a run through of the example                                                                                    
                              21     """                                                                                                                      
       8.12M         20.00M   22     SPEED_OF_SOUND = 1500                                                                                                    
       8.12M         20.00M   23     XZ_DIM = 90                                                                                                              
       8.12M         20.00M   24     Y_DIM = 40                                                                                                               
                              25                                                                                                                              
       8.12M         20.00M   26     def create_pipeline(_settings: sp.Settings):                                                                             
                              27         return [                                                                                                             
                              28             sp.ModelBasedVolumeCreationAdapter(settings),                                                                    
                              29             sp.MCXAdapter(settings),                                                                                         
                              30             sp.KWaveAdapter(settings),                                                                                       
                              31             sp.FieldOfViewCropping(settings),                                                                                
                              32             sp.TimeReversalAdapter(settings)                                                                                 
                              33         ]                                                                                                                    
                              34                                                                                                                              
                              35                                                                                                                              
       8.12M         20.00M   36     def get_device():                                                                                                        
                              37         pa_device = sp.InVision256TF(device_position_mm=np.asarray([XZ_DIM/2, Y_DIM/2, XZ_DIM/2]))                           
                              38         return pa_device                                                                                                     
                              39                                                                                                                              
                              40                                                                                                                              
       8.12M         20.00M   41     def create_volume():                                                                                                     
                              42         inclusion_material = sp.Molecule(volume_fraction=1.0,                                                                
                              43                                          anisotropy_spectrum=sp.AnisotropySpectrumLibrary.CONSTANT_ANISOTROPY_ARBITRARY(     
                              44                                              0.9),                                                                           
                              45                                          scattering_spectrum=sp.AnisotropySpectrumLibrary.CONSTANT_ANISOTROPY_ARBITRARY(     
                              46                                              100.0),                                                                         
                              47                                          absorption_spectrum=sp.AnisotropySpectrumLibrary.CONSTANT_ANISOTROPY_ARBITRARY(     
                              48                                              4.0),                                                                           
                              49                                          speed_of_sound=SPEED_OF_SOUND,                                                      
                              50                                          alpha_coefficient=1e-4,                                                             
                              51                                          density=1000,                                                                       
                              52                                          gruneisen_parameter=1.0,                                                            
                              53                                          name="Inclusion")                                                                   
                              54                                                                                                                              
                              55         phantom_material = sp.Molecule(volume_fraction=1.0,                                                                  
                              56                                        anisotropy_spectrum=sp.AnisotropySpectrumLibrary.CONSTANT_ANISOTROPY_ARBITRARY(0.9),  
                              57                                        scattering_spectrum=sp.AnisotropySpectrumLibrary.CONSTANT_ANISOTROPY_ARBITRARY(       
                              58                                            100.0),                                                                           
                              59                                        absorption_spectrum=sp.AnisotropySpectrumLibrary.CONSTANT_ANISOTROPY_ARBITRARY(0.05), 
                              60                                        speed_of_sound=SPEED_OF_SOUND,                                                        
                              61                                        alpha_coefficient=1e-4,                                                               
                              62                                        density=1000,                                                                         
                              63                                        gruneisen_parameter=1.0,                                                              
                              64                                        name="Phantom")                                                                       
                              65                                                                                                                              
                              66         heavy_water = sp.Molecule(volume_fraction=1.0,                                                                       
                              67                                   anisotropy_spectrum=sp.AnisotropySpectrumLibrary.CONSTANT_ANISOTROPY_ARBITRARY(1.0),       
                              68                                   scattering_spectrum=sp.ScatteringSpectrumLibrary.CONSTANT_SCATTERING_ARBITRARY(0.1),       
                              69                                   absorption_spectrum=sp.AbsorptionSpectrumLibrary.CONSTANT_ABSORBER_ARBITRARY(1e-30),       
                              70                                   speed_of_sound=SPEED_OF_SOUND,                                                             
                              71                                   alpha_coefficient=1e-4,                                                                    
                              72                                   density=1000,                                                                              
                              73                                   gruneisen_parameter=1.0,                                                                   
                              74                                   name="background_water")                                                                   
                              75                                                                                                                              
                              76         background_dictionary = sp.Settings()                                                                                
                              77         background_dictionary[Tags.MOLECULE_COMPOSITION] = (sp.MolecularCompositionGenerator()                               
                              78                                                             .append(heavy_water)                                             
                              79                                                             .get_molecular_composition(segmentation_type=-1))                
                              80         background_dictionary[Tags.STRUCTURE_TYPE] = Tags.BACKGROUND                                                         
                              81                                                                                                                              
                              82         phantom_material_dictionary = sp.Settings()                                                                          
                              83         phantom_material_dictionary[Tags.PRIORITY] = 3                                                                       
                              84         phantom_material_dictionary[Tags.STRUCTURE_START_MM] = [31, 0, 38]                                                   
                              85         phantom_material_dictionary[Tags.STRUCTURE_X_EXTENT_MM] = 28                                                         
                              86         phantom_material_dictionary[Tags.STRUCTURE_Y_EXTENT_MM] = 40                                                         
                              87         phantom_material_dictionary[Tags.STRUCTURE_Z_EXTENT_MM] = 14                                                         
                              88         phantom_material_dictionary[Tags.MOLECULE_COMPOSITION] = (sp.MolecularCompositionGenerator()                         
                              89                                                                   .append(phantom_material)                                  
                              90                                                                   .get_molecular_composition(segmentation_type=0))           
                              91         phantom_material_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = False                                                    
                              92         phantom_material_dictionary[Tags.STRUCTURE_TYPE] = Tags.RECTANGULAR_CUBOID_STRUCTURE                                 
                              93                                                                                                                              
                              94         inclusion_1_dictionary = sp.Settings()                                                                               
                              95         inclusion_1_dictionary[Tags.PRIORITY] = 8                                                                            
                              96         inclusion_1_dictionary[Tags.STRUCTURE_START_MM] = [38, 10, 40]                                                       
                              97         inclusion_1_dictionary[Tags.STRUCTURE_X_EXTENT_MM] = 2                                                               
                              98         inclusion_1_dictionary[Tags.STRUCTURE_Y_EXTENT_MM] = 20                                                              
                              99         inclusion_1_dictionary[Tags.STRUCTURE_Z_EXTENT_MM] = 10                                                              
                             100         inclusion_1_dictionary[Tags.MOLECULE_COMPOSITION] = (sp.MolecularCompositionGenerator()                              
                             101                                                              .append(inclusion_material)                                     
                             102                                                              .get_molecular_composition(segmentation_type=1))                
                             103         inclusion_1_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = False                                                         
                             104         inclusion_1_dictionary[Tags.STRUCTURE_TYPE] = Tags.RECTANGULAR_CUBOID_STRUCTURE                                      
                             105                                                                                                                              
                             106         inclusion_2_dictionary = sp.Settings()                                                                               
                             107         inclusion_2_dictionary[Tags.PRIORITY] = 5                                                                            
                             108         inclusion_2_dictionary[Tags.STRUCTURE_START_MM] = [50, 0, 43]                                                        
                             109         inclusion_2_dictionary[Tags.STRUCTURE_END_MM] = [50, 40, 43]                                                         
                             110         inclusion_2_dictionary[Tags.STRUCTURE_RADIUS_MM] = 2                                                                 
                             111         inclusion_2_dictionary[Tags.MOLECULE_COMPOSITION] = (sp.MolecularCompositionGenerator()                              
                             112                                                              .append(inclusion_material)                                     
                             113                                                              .get_molecular_composition(segmentation_type=2))                
                             114         inclusion_2_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = False                                                         
                             115         inclusion_2_dictionary[Tags.STRUCTURE_TYPE] = Tags.CIRCULAR_TUBULAR_STRUCTURE                                        
                             116                                                                                                                              
                             117         tissue_dict = sp.Settings()                                                                                          
                             118         tissue_dict[Tags.BACKGROUND] = background_dictionary                                                                 
                             119         tissue_dict["phantom"] = phantom_material_dictionary                                                                 
                             120         tissue_dict["inclusion_1"] = inclusion_1_dictionary                                                                  
                             121         tissue_dict["inclusion_2"] = inclusion_2_dictionary                                                                  
                             122         return {                                                                                                             
                             123             Tags.STRUCTURES: tissue_dict,                                                                                    
                             124             Tags.SIMULATE_DEFORMED_LAYERS: False                                                                             
                             125         }                                                                                                                    
                             126                                                                                                                              
                             127                                                                                                                              
       8.12M         20.00M  128     def get_settings():                                                                                                      
                             129         general_settings = {                                                                                                 
                             130             # These parameters set the general properties of the simulated volume                                            
                             131             Tags.RANDOM_SEED: 4711,                                                                                          
                             132             Tags.VOLUME_NAME: "InVision Simulation Example",                                                                 
                             133             Tags.SIMULATION_PATH: path_manager.get_hdf5_file_save_path(),                                                    
                             134             Tags.SPACING_MM: SPACING,                                                                                        
                             135             Tags.DIM_VOLUME_Z_MM: XZ_DIM,                                                                                    
                             136             Tags.DIM_VOLUME_X_MM: XZ_DIM,                                                                                    
                             137             Tags.DIM_VOLUME_Y_MM: Y_DIM,                                                                                     
                             138             Tags.VOLUME_CREATOR: Tags.VOLUME_CREATOR_VERSATILE,                                                              
                             139             Tags.GPU: True,                                                                                                  
                             140             Tags.WAVELENGTHS: [700]                                                                                          
                             141         }                                                                                                                    
                             142                                                                                                                              
                             143         volume_settings = create_volume()                                                                                    
                             144                                                                                                                              
                             145         optical_settings = {                                                                                                 
                             146             Tags.OPTICAL_MODEL_NUMBER_PHOTONS: 1e7,                                                                          
                             147             Tags.OPTICAL_MODEL_BINARY_PATH: path_manager.get_mcx_binary_path(),                                              
                             148             Tags.ILLUMINATION_TYPE: Tags.ILLUMINATION_TYPE_MSOT_INVISION,                                                    
                             149             Tags.LASER_PULSE_ENERGY_IN_MILLIJOULE: 50,                                                                       
                             150         }                                                                                                                    
                             151                                                                                                                              
                             152         acoustic_settings = {                                                                                                
                             153             Tags.ACOUSTIC_SIMULATION_3D: True,                                                                               
                             154             Tags.ACOUSTIC_MODEL_BINARY_PATH: path_manager.get_matlab_binary_path(),                                          
                             155             Tags.KWAVE_PROPERTY_ALPHA_POWER: 0.00,                                                                           
                             156             Tags.KWAVE_PROPERTY_SENSOR_RECORD: "p",                                                                          
                             157             Tags.KWAVE_PROPERTY_PMLInside: False,                                                                            
                             158             Tags.KWAVE_PROPERTY_PMLSize: [31, 32],                                                                           
                             159             Tags.KWAVE_PROPERTY_PMLAlpha: 1.5,                                                                               
                             160             Tags.KWAVE_PROPERTY_PlotPML: False,                                                                              
                             161             Tags.RECORDMOVIE: False,                                                                                         
                             162             Tags.MOVIENAME: "visualization_log",                                                                             
                             163             Tags.ACOUSTIC_LOG_SCALE: True                                                                                    
                             164         }                                                                                                                    
                             165                                                                                                                              
                             166         reconstruction_settings = {                                                                                          
                             167             Tags.RECONSTRUCTION_PERFORM_BANDPASS_FILTERING: False,                                                           
                             168             Tags.TUKEY_WINDOW_ALPHA: 0.5,                                                                                    
                             169             Tags.RECONSTRUCTION_BMODE_AFTER_RECONSTRUCTION: False,                                                           
                             170             Tags.RECONSTRUCTION_BMODE_METHOD: Tags.RECONSTRUCTION_BMODE_METHOD_HILBERT_TRANSFORM,                            
                             171             Tags.RECONSTRUCTION_APODIZATION_METHOD: Tags.RECONSTRUCTION_APODIZATION_HAMMING,                                 
                             172             Tags.RECONSTRUCTION_MODE: Tags.RECONSTRUCTION_MODE_PRESSURE,                                                     
                             173             Tags.DATA_FIELD_SPEED_OF_SOUND: SPEED_OF_SOUND,                                                                  
                             174             Tags.KWAVE_PROPERTY_SENSOR_RECORD: "p",                                                                          
                             175             Tags.KWAVE_PROPERTY_PMLInside: False,                                                                            
                             176             Tags.KWAVE_PROPERTY_PMLSize: [31, 32],                                                                           
                             177             Tags.KWAVE_PROPERTY_PMLAlpha: 1.5,                                                                               
                             178             Tags.KWAVE_PROPERTY_PlotPML: False,                                                                              
                             179             Tags.RECORDMOVIE: False,                                                                                         
                             180             Tags.MOVIENAME: "visualization_log",                                                                             
                             181             Tags.ACOUSTIC_LOG_SCALE: True,                                                                                   
                             182             Tags.ACOUSTIC_MODEL_BINARY_PATH: path_manager.get_matlab_binary_path(),                                          
                             183             Tags.KWAVE_PROPERTY_ALPHA_POWER: 0.00,                                                                           
                             184             Tags.SPACING_MM: 0.25,                                                                                           
                             185         }                                                                                                                    
                             186                                                                                                                              
                             187         _settings = sp.Settings(general_settings)                                                                            
                             188         _settings.set_volume_creation_settings(volume_settings)                                                              
                             189         _settings.set_optical_settings(optical_settings)                                                                     
                             190         _settings.set_acoustic_settings(acoustic_settings)                                                                   
                             191         _settings.set_reconstruction_settings(reconstruction_settings)                                                       
                             192         return _settings                                                                                                     
                             193                                                                                                                              
                             194                                                                                                                              
       8.12M         20.00M  195     device = get_device()                                                                                                    
       8.12M         20.00M  196     settings = get_settings()                                                                                                
       8.12M         20.00M  197     pipeline = create_pipeline(settings)                                                                                     
                             198                                                                                                                              
     442.87M        556.00M  199     sp.simulate(simulation_pipeline=pipeline, digital_device_twin=device, settings=settings)                                 
                             200                                                                                                                              
       8.12M         20.00M  201     if visualise:                                                                                                            
                             202         sp.visualise_data(settings=settings,                                                                                 
                             203                           path_manager=path_manager,                                                                         
                             204                           show_absorption=True,                                                                              
                             205                           show_initial_pressure=True,                                                                        
                             206                           show_reconstructed_data=True,                                                                      
                             207                           show_xz_only=True)                                                                                 
## run_minimal_optical_simulation_uniform_cube

active_bytes reserved_bytes line code                                                                                                              
         all            all                                                                                                                        
        peak           peak                                                                                                                        
       8.12M         42.00M   22 @profile                                                                                                          
                              23 def run_minimal_optical_simulation_uniform_cube(SPACING: Union[int, float] = 0.5, path_manager=sp.PathManager(),  
                              24                                                 visualise:bool = True):                                           
                              25     """                                                                                                           
                              26                                                                                                                   
                              27     :param SPACING: The simulation spacing between voxels                                                         
                              28     :param path_manager: the path manager to be used, typically sp.PathManager                                    
                              29     :param visualise: If VISUALIZE is set to True, the reconstruction result will be plotted                      
                              30     :return: a run through of the example                                                                         
                              31     """                                                                                                           
       8.12M         42.00M   32     VOLUME_TRANSDUCER_DIM_IN_MM = 60                                                                              
       8.12M         42.00M   33     VOLUME_PLANAR_DIM_IN_MM = 30                                                                                  
       8.12M         42.00M   34     VOLUME_HEIGHT_IN_MM = 60                                                                                      
       8.12M         42.00M   35     RANDOM_SEED = 471                                                                                             
       8.12M         42.00M   36     VOLUME_NAME = "MyVolumeName_"+str(RANDOM_SEED)                                                                
       8.12M         42.00M   37     SAVE_REFLECTANCE = True                                                                                       
       8.12M         42.00M   38     SAVE_PHOTON_DIRECTION = False                                                                                 
                              39                                                                                                                   
                              40     # If VISUALIZE is set to True, the simulation result will be plotted                                          
       8.12M         42.00M   41     VISUALIZE = True                                                                                              
                              42                                                                                                                   
                              43                                                                                                                   
       8.12M         42.00M   44     def create_example_tissue():                                                                                  
                              45         """                                                                                                       
                              46         This is a very simple example script of how to create a tissue definition.                                
                              47         It contains only a generic background tissue material.                                                    
                              48         """                                                                                                       
                              49         background_dictionary = sp.Settings()                                                                     
                              50         background_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(1e-4, 1e-4, 0.9)            
                              51         background_dictionary[Tags.STRUCTURE_TYPE] = Tags.BACKGROUND                                              
                              52                                                                                                                   
                              53         tissue_dict = sp.Settings()                                                                               
                              54         tissue_dict[Tags.BACKGROUND] = background_dictionary                                                      
                              55         return tissue_dict                                                                                        
                              56                                                                                                                   
                              57                                                                                                                   
                              58     # Seed the numpy random configuration prior to creating the global_settings file in                           
                              59     # order to ensure that the same volume                                                                        
                              60     # is generated with the same random seed every time.                                                          
                              61                                                                                                                   
       8.12M         42.00M   62     np.random.seed(RANDOM_SEED)                                                                                   
                              63                                                                                                                   
       8.12M         42.00M   64     general_settings = {                                                                                          
                              65         # These parameters set the general properties of the simulated volume                                     
       8.12M         42.00M   66         Tags.RANDOM_SEED: RANDOM_SEED,                                                                            
       8.12M         42.00M   67         Tags.VOLUME_NAME: VOLUME_NAME,                                                                            
       8.12M         42.00M   68         Tags.SIMULATION_PATH: path_manager.get_hdf5_file_save_path(),                                             
       8.12M         42.00M   69         Tags.SPACING_MM: SPACING,                                                                                 
       8.12M         42.00M   70         Tags.DIM_VOLUME_Z_MM: VOLUME_HEIGHT_IN_MM,                                                                
       8.12M         42.00M   71         Tags.DIM_VOLUME_X_MM: VOLUME_TRANSDUCER_DIM_IN_MM,                                                        
       8.12M         42.00M   72         Tags.DIM_VOLUME_Y_MM: VOLUME_PLANAR_DIM_IN_MM,                                                            
       8.12M         42.00M   73         Tags.WAVELENGTHS: [500],                                                                                  
       8.12M         42.00M   74         Tags.DO_FILE_COMPRESSION: True                                                                            
                              75     }                                                                                                             
                              76                                                                                                                   
       8.12M         42.00M   77     settings = sp.Settings(general_settings)                                                                      
                              78                                                                                                                   
       8.12M         42.00M   79     settings.set_volume_creation_settings({                                                                       
       8.12M         42.00M   80         Tags.STRUCTURES: create_example_tissue()                                                                  
                              81     })                                                                                                            
       8.12M         42.00M   82     settings.set_optical_settings({                                                                               
       8.12M         42.00M   83         Tags.OPTICAL_MODEL_NUMBER_PHOTONS: 5e7,                                                                   
       8.12M         42.00M   84         Tags.OPTICAL_MODEL_BINARY_PATH: path_manager.get_mcx_binary_path(),                                       
       8.12M         42.00M   85         Tags.COMPUTE_DIFFUSE_REFLECTANCE: SAVE_REFLECTANCE,                                                       
       8.12M         42.00M   86         Tags.COMPUTE_PHOTON_DIRECTION_AT_EXIT: SAVE_PHOTON_DIRECTION                                              
                              87     })                                                                                                            
                              88                                                                                                                   
       8.12M         42.00M   89     pipeline = [                                                                                                  
       8.12M         42.00M   90         sp.ModelBasedVolumeCreationAdapter(settings),                                                             
       8.12M         42.00M   91         sp.MCXAdapterReflectance(settings),                                                                       
                              92     ]                                                                                                             
                              93                                                                                                                   
       8.12M         42.00M   94     device = sp.PencilBeamIlluminationGeometry(device_position_mm=np.asarray([VOLUME_TRANSDUCER_DIM_IN_MM/2,      
       8.12M         42.00M   95                                                                               VOLUME_PLANAR_DIM_IN_MM/2, 0]))     
                              96                                                                                                                   
     155.75M        162.00M   97     sp.simulate(pipeline, settings, device)                                                                       
                              98                                                                                                                   
       8.12M         20.00M   99     if visualise:                                                                                                 
                             100         sp.visualise_data(path_to_hdf5_file=path_manager.get_hdf5_file_save_path() + "/" + VOLUME_NAME + ".hdf5", 
                             101                           wavelength=settings[Tags.WAVELENGTH],                                                   
                             102                           show_initial_pressure=True,                                                             
                             103                           show_absorption=True,                                                                   
                             104                           show_diffuse_reflectance=SAVE_REFLECTANCE,                                              
                             105                           log_scale=True)                                                                         
## run_minimal_optical_simulation

active_bytes reserved_bytes line code                                                                                                                         
         all            all                                                                                                                                   
        peak           peak                                                                                                                                   
       8.12M         20.00M   19 @profile                                                                                                                     
                              20 def run_minimal_optical_simulation(SPACING: Union[int, float] = 0.5, path_manager=sp.PathManager(), visualise: bool = True): 
                              21     """                                                                                                                      
                              22                                                                                                                              
                              23     :param SPACING: The simulation spacing between voxels                                                                    
                              24     :param path_manager: the path manager to be used, typically sp.PathManager                                               
                              25     :param visualise: If VISUALIZE is set to True, the reconstruction result will be plotted                                 
                              26     :return: a run through of the example                                                                                    
                              27     """                                                                                                                      
       8.12M         20.00M   28     VOLUME_TRANSDUCER_DIM_IN_MM = 60                                                                                         
       8.12M         20.00M   29     VOLUME_PLANAR_DIM_IN_MM = 30                                                                                             
       8.12M         20.00M   30     VOLUME_HEIGHT_IN_MM = 60                                                                                                 
       8.12M         20.00M   31     RANDOM_SEED = 471                                                                                                        
       8.12M         20.00M   32     VOLUME_NAME = "MyVolumeName_"+str(RANDOM_SEED)                                                                           
       8.12M         20.00M   33     SAVE_REFLECTANCE = False                                                                                                 
       8.12M         20.00M   34     SAVE_PHOTON_DIRECTION = False                                                                                            
                              35                                                                                                                              
                              36     # If VISUALIZE is set to True, the simulation result will be plotted                                                     
                              37                                                                                                                              
       8.12M         20.00M   38     def create_example_tissue():                                                                                             
                              39         """                                                                                                                  
                              40         This is a very simple example script of how to create a tissue definition.                                           
                              41         It contains a muscular background, an epidermis layer on top of the muscles                                          
                              42         and a blood vessel.                                                                                                  
                              43         """                                                                                                                  
                              44         background_dictionary = sp.Settings()                                                                                
                              45         background_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(1e-4, 1e-4, 0.9)                       
                              46         background_dictionary[Tags.STRUCTURE_TYPE] = Tags.BACKGROUND                                                         
                              47                                                                                                                              
                              48         muscle_dictionary = sp.Settings()                                                                                    
                              49         muscle_dictionary[Tags.PRIORITY] = 1                                                                                 
                              50         muscle_dictionary[Tags.STRUCTURE_START_MM] = [0, 0, 10]                                                              
                              51         muscle_dictionary[Tags.STRUCTURE_END_MM] = [0, 0, 100]                                                               
                              52         muscle_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.muscle()                                            
                              53         muscle_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                               
                              54         muscle_dictionary[Tags.ADHERE_TO_DEFORMATION] = True                                                                 
                              55         muscle_dictionary[Tags.STRUCTURE_TYPE] = Tags.HORIZONTAL_LAYER_STRUCTURE                                             
                              56                                                                                                                              
                              57         vessel_1_dictionary = sp.Settings()                                                                                  
                              58         vessel_1_dictionary[Tags.PRIORITY] = 3                                                                               
                              59         vessel_1_dictionary[Tags.STRUCTURE_START_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM/2,                                       
                              60                                                         10,                                                                  
                              61                                                         VOLUME_HEIGHT_IN_MM/2]                                               
                              62         vessel_1_dictionary[Tags.STRUCTURE_END_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM/2,                                         
                              63                                                       12,                                                                    
                              64                                                       VOLUME_HEIGHT_IN_MM/2]                                                 
                              65         vessel_1_dictionary[Tags.STRUCTURE_RADIUS_MM] = 3                                                                    
                              66         vessel_1_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.blood()                                           
                              67         vessel_1_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                             
                              68         vessel_1_dictionary[Tags.STRUCTURE_TYPE] = Tags.CIRCULAR_TUBULAR_STRUCTURE                                           
                              69                                                                                                                              
                              70         epidermis_dictionary = sp.Settings()                                                                                 
                              71         epidermis_dictionary[Tags.PRIORITY] = 8                                                                              
                              72         epidermis_dictionary[Tags.STRUCTURE_START_MM] = [0, 0, 9]                                                            
                              73         epidermis_dictionary[Tags.STRUCTURE_END_MM] = [0, 0, 10]                                                             
                              74         epidermis_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.epidermis()                                      
                              75         epidermis_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                            
                              76         epidermis_dictionary[Tags.ADHERE_TO_DEFORMATION] = True                                                              
                              77         epidermis_dictionary[Tags.STRUCTURE_TYPE] = Tags.HORIZONTAL_LAYER_STRUCTURE                                          
                              78                                                                                                                              
                              79         tissue_dict = sp.Settings()                                                                                          
                              80         tissue_dict[Tags.BACKGROUND] = background_dictionary                                                                 
                              81         tissue_dict["muscle"] = muscle_dictionary                                                                            
                              82         tissue_dict["epidermis"] = epidermis_dictionary                                                                      
                              83         tissue_dict["vessel_1"] = vessel_1_dictionary                                                                        
                              84         return tissue_dict                                                                                                   
                              85                                                                                                                              
                              86                                                                                                                              
                              87     # Seed the numpy random configuration prior to creating the global_settings file in                                      
                              88     # order to ensure that the same volume                                                                                   
                              89     # is generated with the same random seed every time.                                                                     
                              90                                                                                                                              
       8.12M         20.00M   91     np.random.seed(RANDOM_SEED)                                                                                              
                              92                                                                                                                              
       8.12M         20.00M   93     general_settings = {                                                                                                     
                              94         # These parameters set the general properties of the simulated volume                                                
       8.12M         20.00M   95         Tags.RANDOM_SEED: RANDOM_SEED,                                                                                       
       8.12M         20.00M   96         Tags.VOLUME_NAME: VOLUME_NAME,                                                                                       
       8.12M         20.00M   97         Tags.SIMULATION_PATH: path_manager.get_hdf5_file_save_path(),                                                        
       8.12M         20.00M   98         Tags.SPACING_MM: SPACING,                                                                                            
       8.12M         20.00M   99         Tags.DIM_VOLUME_Z_MM: VOLUME_HEIGHT_IN_MM,                                                                           
       8.12M         20.00M  100         Tags.DIM_VOLUME_X_MM: VOLUME_TRANSDUCER_DIM_IN_MM,                                                                   
       8.12M         20.00M  101         Tags.DIM_VOLUME_Y_MM: VOLUME_PLANAR_DIM_IN_MM,                                                                       
       8.12M         20.00M  102         Tags.WAVELENGTHS: [798],                                                                                             
       8.12M         20.00M  103         Tags.DO_FILE_COMPRESSION: True,                                                                                      
       8.12M         20.00M  104         Tags.GPU: True                                                                                                       
                             105     }                                                                                                                        
                             106                                                                                                                              
       8.12M         20.00M  107     settings = sp.Settings(general_settings)                                                                                 
                             108                                                                                                                              
       8.12M         20.00M  109     settings.set_volume_creation_settings({                                                                                  
       8.12M         20.00M  110         Tags.SIMULATE_DEFORMED_LAYERS: True,                                                                                 
       8.12M         20.00M  111         Tags.STRUCTURES: create_example_tissue()                                                                             
                             112     })                                                                                                                       
       8.12M         20.00M  113     settings.set_optical_settings({                                                                                          
       8.12M         20.00M  114         Tags.OPTICAL_MODEL_NUMBER_PHOTONS: 5e7,                                                                              
       8.12M         20.00M  115         Tags.OPTICAL_MODEL_BINARY_PATH: path_manager.get_mcx_binary_path(),                                                  
       8.12M         20.00M  116         Tags.COMPUTE_DIFFUSE_REFLECTANCE: SAVE_REFLECTANCE,                                                                  
       8.12M         20.00M  117         Tags.COMPUTE_PHOTON_DIRECTION_AT_EXIT: SAVE_PHOTON_DIRECTION                                                         
                             118     })                                                                                                                       
       8.12M         20.00M  119     settings["noise_model_1"] = {                                                                                            
       8.12M         20.00M  120         Tags.NOISE_MEAN: 1.0,                                                                                                
       8.12M         20.00M  121         Tags.NOISE_STD: 0.1,                                                                                                 
       8.12M         20.00M  122         Tags.NOISE_MODE: Tags.NOISE_MODE_MULTIPLICATIVE,                                                                     
       8.12M         20.00M  123         Tags.DATA_FIELD: Tags.DATA_FIELD_INITIAL_PRESSURE,                                                                   
       8.12M         20.00M  124         Tags.NOISE_NON_NEGATIVITY_CONSTRAINT: True                                                                           
                             125     }                                                                                                                        
                             126                                                                                                                              
       8.12M         20.00M  127     if not SAVE_REFLECTANCE and not SAVE_PHOTON_DIRECTION:                                                                   
       8.12M         20.00M  128         pipeline = [                                                                                                         
       8.12M         20.00M  129             sp.ModelBasedVolumeCreationAdapter(settings),                                                                    
       8.12M         20.00M  130             sp.MCXAdapter(settings),                                                                                         
       8.12M         20.00M  131             sp.GaussianNoise(settings, "noise_model_1")                                                                      
                             132         ]                                                                                                                    
                             133     else:                                                                                                                    
                             134         pipeline = [                                                                                                         
                             135             sp.ModelBasedVolumeCreationAdapter(settings),                                                                    
                             136             sp.MCXAdapterReflectance(settings),                                                                              
                             137         ]                                                                                                                    
                             138                                                                                                                              
                             139                                                                                                                              
       8.12M         20.00M  140     class ExampleDeviceSlitIlluminationLinearDetector(sp.PhotoacousticDevice):                                               
                             141         """                                                                                                                  
                             142         This class represents a digital twin of a PA device with a slit as illumination next to a linear detection geometry. 
                             143                                                                                                                              
                             144         """                                                                                                                  
                             145                                                                                                                              
                             146         def __init__(self):                                                                                                  
                             147             super().__init__(device_position_mm=np.asarray([VOLUME_TRANSDUCER_DIM_IN_MM/2,                                   
                             148                                                             VOLUME_PLANAR_DIM_IN_MM/2, 0]))                                  
                             149             self.set_detection_geometry(sp.LinearArrayDetectionGeometry())                                                   
                             150             self.add_illumination_geometry(sp.SlitIlluminationGeometry(slit_vector_mm=[20, 0, 0],                            
                             151                                                                        direction_vector_mm=[0, 0, 1]))                       
                             152                                                                                                                              
                             153                                                                                                                              
       8.12M         20.00M  154     device = ExampleDeviceSlitIlluminationLinearDetector()                                                                   
                             155                                                                                                                              
     160.20M        220.00M  156     sp.simulate(pipeline, settings, device)                                                                                  
                             157                                                                                                                              
       8.12M         42.00M  158     if Tags.WAVELENGTH in settings:                                                                                          
       8.12M         42.00M  159         WAVELENGTH = settings[Tags.WAVELENGTH]                                                                               
                             160     else:                                                                                                                    
                             161         WAVELENGTH = 700                                                                                                     
                             162                                                                                                                              
       8.12M         42.00M  163     if visualise:                                                                                                            
                             164         sp.visualise_data(path_to_hdf5_file=path_manager.get_hdf5_file_save_path() + "/" + VOLUME_NAME + ".hdf5",            
                             165                           wavelength=WAVELENGTH,                                                                             
                             166                           show_initial_pressure=True,                                                                        
                             167                           show_absorption=True,                                                                              
                             168                           show_diffuse_reflectance=SAVE_REFLECTANCE,                                                         
                             169                           log_scale=True)                                                                                    
## run_linear_unmixing

active_bytes reserved_bytes line code                                                                                                                   
         all            all                                                                                                                             
        peak           peak                                                                                                                             
       0.00B          0.00B   18 @profile                                                                                                               
                              19 def run_linear_unmixing(SPACING: Union[int, float] = 0.25, path_manager=sp.PathManager, visualise: bool = True):       
                              20     """                                                                                                                
                              21                                                                                                                        
                              22     :param SPACING: The simulation spacing between voxels                                                              
                              23     :param path_manager: the path manager to be used, typically sp.PathManager                                         
                              24     :param visualise: If VISUALIZE is set to True, the reconstruction result will be plotted                           
                              25     :return: a run through of the example                                                                              
                              26     """                                                                                                                
                              27     # TODO: Please make sure that a valid path_config.env file is located in your home directory, or that you          
                              28     # set global params characterizing the simulated volume                                                            
       0.00B          0.00B   29     VOLUME_TRANSDUCER_DIM_IN_MM = 75                                                                                   
       0.00B          0.00B   30     VOLUME_PLANAR_DIM_IN_MM = 20                                                                                       
       0.00B          0.00B   31     VOLUME_HEIGHT_IN_MM = 25                                                                                           
       0.00B          0.00B   32     RANDOM_SEED = 471                                                                                                  
       0.00B          0.00B   33     VOLUME_NAME = "LinearUnmixingExample_" + str(RANDOM_SEED)                                                          
                              34                                                                                                                        
                              35     # since we want to perform linear unmixing, the simulation pipeline should be execute for at least two wavelengths 
       0.00B          0.00B   36     WAVELENGTHS = [750, 800, 850]                                                                                      
                              37                                                                                                                        
       0.00B          0.00B   38     def create_example_tissue():                                                                                       
                              39         """                                                                                                            
                              40         This is a very simple example script of how to create a tissue definition.                                     
                              41         It contains a muscular background, an epidermis layer on top of the muscles                                    
                              42         and two blood vessels.                                                                                         
                              43         """                                                                                                            
                              44         background_dictionary = sp.Settings()                                                                          
                              45         background_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.constant(1e-4, 1e-4, 0.9)                 
                              46         background_dictionary[Tags.STRUCTURE_TYPE] = Tags.BACKGROUND                                                   
                              47                                                                                                                        
                              48         muscle_dictionary = sp.Settings()                                                                              
                              49         muscle_dictionary[Tags.PRIORITY] = 1                                                                           
                              50         muscle_dictionary[Tags.STRUCTURE_START_MM] = [0, 0, 0]                                                         
                              51         muscle_dictionary[Tags.STRUCTURE_END_MM] = [0, 0, 100]                                                         
                              52         muscle_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.muscle()                                      
                              53         muscle_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                         
                              54         muscle_dictionary[Tags.ADHERE_TO_DEFORMATION] = True                                                           
                              55         muscle_dictionary[Tags.STRUCTURE_TYPE] = Tags.HORIZONTAL_LAYER_STRUCTURE                                       
                              56                                                                                                                        
                              57         vessel_1_dictionary = sp.Settings()                                                                            
                              58         vessel_1_dictionary[Tags.PRIORITY] = 3                                                                         
                              59         vessel_1_dictionary[Tags.STRUCTURE_START_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM/2,                                 
                              60                                                         10,                                                            
                              61                                                         5]                                                             
                              62         vessel_1_dictionary[Tags.STRUCTURE_END_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM/2,                                   
                              63                                                       12,                                                              
                              64                                                       5]                                                               
                              65         vessel_1_dictionary[Tags.STRUCTURE_RADIUS_MM] = 3                                                              
                              66         vessel_1_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.blood(oxygenation=0.99)                     
                              67         vessel_1_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                       
                              68         vessel_1_dictionary[Tags.STRUCTURE_TYPE] = Tags.CIRCULAR_TUBULAR_STRUCTURE                                     
                              69                                                                                                                        
                              70         vessel_2_dictionary = sp.Settings()                                                                            
                              71         vessel_2_dictionary[Tags.PRIORITY] = 3                                                                         
                              72         vessel_2_dictionary[Tags.STRUCTURE_START_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM/3,                                 
                              73                                                         10,                                                            
                              74                                                         5]                                                             
                              75         vessel_2_dictionary[Tags.STRUCTURE_END_MM] = [VOLUME_TRANSDUCER_DIM_IN_MM/3,                                   
                              76                                                       12,                                                              
                              77                                                       5]                                                               
                              78         vessel_2_dictionary[Tags.STRUCTURE_RADIUS_MM] = 2                                                              
                              79         vessel_2_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.blood(oxygenation=0.75)                     
                              80         vessel_2_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                       
                              81         vessel_2_dictionary[Tags.STRUCTURE_TYPE] = Tags.CIRCULAR_TUBULAR_STRUCTURE                                     
                              82                                                                                                                        
                              83         epidermis_dictionary = sp.Settings()                                                                           
                              84         epidermis_dictionary[Tags.PRIORITY] = 8                                                                        
                              85         epidermis_dictionary[Tags.STRUCTURE_START_MM] = [0, 0, 0]                                                      
                              86         epidermis_dictionary[Tags.STRUCTURE_END_MM] = [0, 0, 0.1]                                                      
                              87         epidermis_dictionary[Tags.MOLECULE_COMPOSITION] = sp.TISSUE_LIBRARY.epidermis()                                
                              88         epidermis_dictionary[Tags.CONSIDER_PARTIAL_VOLUME] = True                                                      
                              89         epidermis_dictionary[Tags.ADHERE_TO_DEFORMATION] = True                                                        
                              90         epidermis_dictionary[Tags.STRUCTURE_TYPE] = Tags.HORIZONTAL_LAYER_STRUCTURE                                    
                              91                                                                                                                        
                              92         tissue_dict = sp.Settings()                                                                                    
                              93         tissue_dict[Tags.BACKGROUND] = background_dictionary                                                           
                              94         tissue_dict["muscle"] = muscle_dictionary                                                                      
                              95         tissue_dict["epidermis"] = epidermis_dictionary                                                                
                              96         tissue_dict["vessel_1"] = vessel_1_dictionary                                                                  
                              97         tissue_dict["vessel_2"] = vessel_2_dictionary                                                                  
                              98         return tissue_dict                                                                                             
                              99                                                                                                                        
                             100                                                                                                                        
                             101     # Seed the numpy random configuration prior to creating the global_settings file in                                
                             102     # order to ensure that the same volume is generated with the same random seed every time.                          
       0.00B          0.00B  103     np.random.seed(RANDOM_SEED)                                                                                        
                             104                                                                                                                        
                             105     # Initialize global settings and prepare for simulation pipeline including                                         
                             106     # volume creation and optical forward simulation.                                                                  
       0.00B          0.00B  107     general_settings = {                                                                                               
                             108         # These parameters set the general properties of the simulated volume                                          
       0.00B          0.00B  109         Tags.RANDOM_SEED: RANDOM_SEED,                                                                                 
       0.00B          0.00B  110         Tags.VOLUME_NAME: VOLUME_NAME,                                                                                 
       0.00B          0.00B  111         Tags.SIMULATION_PATH: path_manager.get_hdf5_file_save_path(),                                                  
       0.00B          0.00B  112         Tags.SPACING_MM: SPACING,                                                                                      
       0.00B          0.00B  113         Tags.DIM_VOLUME_Z_MM: VOLUME_HEIGHT_IN_MM,                                                                     
       0.00B          0.00B  114         Tags.DIM_VOLUME_X_MM: VOLUME_TRANSDUCER_DIM_IN_MM,                                                             
       0.00B          0.00B  115         Tags.DIM_VOLUME_Y_MM: VOLUME_PLANAR_DIM_IN_MM,                                                                 
       0.00B          0.00B  116         Tags.WAVELENGTHS: WAVELENGTHS,                                                                                 
       0.00B          0.00B  117         Tags.GPU: True,                                                                                                
       0.00B          0.00B  118         Tags.DO_FILE_COMPRESSION: True                                                                                 
                             119     }                                                                                                                  
       0.00B          0.00B  120     settings = sp.Settings(general_settings)                                                                           
       0.00B          0.00B  121     settings.set_volume_creation_settings({                                                                            
       0.00B          0.00B  122         Tags.SIMULATE_DEFORMED_LAYERS: True,                                                                           
       0.00B          0.00B  123         Tags.STRUCTURES: create_example_tissue()                                                                       
                             124     })                                                                                                                 
       0.00B          0.00B  125     settings.set_optical_settings({                                                                                    
       0.00B          0.00B  126         Tags.OPTICAL_MODEL_NUMBER_PHOTONS: 1e7,                                                                        
       0.00B          0.00B  127         Tags.OPTICAL_MODEL_BINARY_PATH: path_manager.get_mcx_binary_path(),                                            
       0.00B          0.00B  128         Tags.OPTICAL_MODEL: Tags.OPTICAL_MODEL_MCX,                                                                    
       0.00B          0.00B  129         Tags.LASER_PULSE_ENERGY_IN_MILLIJOULE: 50                                                                      
                             130     })                                                                                                                 
                             131                                                                                                                        
                             132     # Set component settings for linear unmixing.                                                                      
                             133     # In this example we are only interested in the chromophore concentration of oxy- and deoxyhemoglobin and the      
                             134     # resulting blood oxygen saturation. We want to perform the algorithm using all three wavelengths defined above.   
                             135     # Please take a look at the component for more information.                                                        
       0.00B          0.00B  136     settings["linear_unmixing"] = {                                                                                    
       0.00B          0.00B  137         Tags.DATA_FIELD: Tags.DATA_FIELD_INITIAL_PRESSURE,                                                             
       0.00B          0.00B  138         Tags.WAVELENGTHS: WAVELENGTHS,                                                                                 
       0.00B          0.00B  139         Tags.LINEAR_UNMIXING_SPECTRA: sp.get_simpa_internal_absorption_spectra_by_names(                               
       0.00B          0.00B  140             [Tags.SIMPA_NAMED_ABSORPTION_SPECTRUM_OXYHEMOGLOBIN, Tags.SIMPA_NAMED_ABSORPTION_SPECTRUM_DEOXYHEMOGLOBIN] 
                             141         ),                                                                                                             
       0.00B          0.00B  142         Tags.LINEAR_UNMIXING_COMPUTE_SO2: True,                                                                        
       0.00B          0.00B  143         Tags.LINEAR_UNMIXING_NON_NEGATIVE: True                                                                        
                             144     }                                                                                                                  
                             145                                                                                                                        
                             146     # Get device for simulation                                                                                        
       0.00B          0.00B  147     device = sp.MSOTAcuityEcho(device_position_mm=np.array([VOLUME_TRANSDUCER_DIM_IN_MM/2,                             
       0.00B          0.00B  148                                                             VOLUME_PLANAR_DIM_IN_MM/2,                                 
       0.00B          0.00B  149                                                             0]))                                                       
       0.00B          0.00B  150     device.update_settings_for_use_of_model_based_volume_creator(settings)                                             
                             151                                                                                                                        
                             152     # Run simulation pipeline for all wavelengths in Tag.WAVELENGTHS                                                   
       0.00B          0.00B  153     pipeline = [                                                                                                       
       0.00B          0.00B  154         sp.ModelBasedVolumeCreationAdapter(settings),                                                                  
       0.00B          0.00B  155         sp.MCXAdapter(settings),                                                                                       
       0.00B          0.00B  156         sp.FieldOfViewCropping(settings),                                                                              
                             157     ]                                                                                                                  
     139.43M        192.00M  158     sp.simulate(pipeline, settings, device)                                                                            
                             159                                                                                                                        
                             160     # Run linear unmixing component with above specified settings.                                                     
       8.12M         20.00M  161     sp.LinearUnmixing(settings, "linear_unmixing").run()                                                               
                             162                                                                                                                        
                             163     # Load linear unmixing result (blood oxygen saturation) and reference absorption for first wavelength.             
       8.12M         20.00M  164     file_path = path_manager.get_hdf5_file_save_path() + "/" + VOLUME_NAME + ".hdf5"                                   
       8.12M         20.00M  165     lu_results = sp.load_data_field(file_path, Tags.LINEAR_UNMIXING_RESULT)                                            
       8.12M         20.00M  166     sO2 = lu_results["sO2"]                                                                                            
                             167                                                                                                                        
       8.12M         20.00M  168     mua = sp.load_data_field(file_path, Tags.DATA_FIELD_ABSORPTION_PER_CM, wavelength=WAVELENGTHS[0])                  
       8.12M         20.00M  169     p0 = sp.load_data_field(file_path, Tags.DATA_FIELD_INITIAL_PRESSURE, wavelength=WAVELENGTHS[0])                    
       8.12M         20.00M  170     gt_oxy = sp.load_data_field(file_path, Tags.DATA_FIELD_OXYGENATION, wavelength=WAVELENGTHS[0])                     
                             171                                                                                                                        
                             172     # Visualize linear unmixing result                                                                                 
       8.12M         20.00M  173     if visualise:                                                                                                      
                             174         visualise_data(path_to_hdf5_file=path_manager.get_hdf5_file_save_path() + "/" + VOLUME_NAME + ".hdf5",         
                             175                        wavelength=WAVELENGTHS[0],                                                                      
                             176                        show_initial_pressure=True,                                                                     
                             177                        show_oxygenation=True,                                                                          
                             178                        show_linear_unmixing_sO2=True)                                                                  
